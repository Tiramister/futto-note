## Context

Step 5 までで、認証済みユーザーはメッセージ一覧の閲覧と新規メッセージ投稿ができる状態になっている。一方で投稿後の本文修正ができず、実運用では誤入力や内容更新に対応できない。

本 change では `PUT /api/messages/:id` を追加し、タイムライン上で対象メッセージをインライン編集できる UI を実装する。データモデル変更は行わず、既存 `messages` テーブルを利用する。

## Goals / Non-Goals

**Goals:**
- 認証必須の `PUT /api/messages/:id` を追加し、空文字更新を 400、対象なしを 404 として扱う。
- 更新対象を `id` と `user_id` で絞り込み、他ユーザーのデータ更新を防止する。
- メッセージ行に操作メニューを追加し、「編集」選択でインライン編集に切り替える。
- 「保存」で更新 API を実行して画面へ反映し、「キャンセル」で編集開始前の表示へ戻す。

**Non-Goals:**
- メッセージ削除機能（Step 7 で対応）。
- クリップボードコピー機能（Step 8 で対応）。
- Markdown 対応や URL リンク化ルールの変更。
- `messages` テーブルのスキーマ変更。

## Decisions

### 1. 更新 API は認証ミドルウェア配下で `PUT /api/messages/{id}` として実装する

- 決定: 既存のメッセージ API と同じ保護境界で `PUT` を追加し、`user_id` はコンテキストから取得する。
- 理由: 認証実装の重複を防ぎ、一覧/作成と同じアクセス制御ポリシーを維持できる。
- 代替案: ハンドラー内部で個別認証する方式は重複実装になるため不採用。

### 2. SQL は `UPDATE ... WHERE id = $2 AND user_id = $3 RETURNING ...` を採用する

- 決定: 1 クエリで権限制御と更新結果取得を行い、`sql.ErrNoRows` を 404 にマップする。
- 理由: 読み取り後更新の 2 段階処理より簡潔で、競合時の不整合を減らせる。
- 代替案: 事前 `SELECT` で存在確認する方式はクエリ増加と race の可能性があるため不採用。

### 3. 編集状態は `App.tsx` で管理し、`MessageList` は表示・入力 UI に集中させる

- 決定: 編集中メッセージ ID、編集本文、更新中フラグ、エラー文言を `App` で保持し、`MessageList` へ props として渡す。
- 理由: API 呼び出し責務を `App` 側へ集約し、`MessageList` をテスタブルな描画コンポーネントとして維持できる。
- 代替案: `MessageList` に fetch を持たせる方式は責務が混在するため不採用。

### 4. 編集操作はメッセージごとの `...` ボタン経由で開始する

- 決定: メッセージ行にトリガーを置き、「編集」ボタン表示後にインライン編集へ遷移させる。
- 理由: Step 7/8 の削除・コピー操作を同じメニューへ拡張しやすい。
- 代替案: 常時「編集」ボタンを表示する方式は拡張性と視認ノイズの面で不採用。

## Risks / Trade-offs

- [Risk] 編集中に別メッセージを誤って開いて状態が競合する  
  → Mitigation: 1 件のみ編集可能に制限し、編集開始時に対象 ID を単一管理する。
- [Risk] ネットワーク失敗時に保存できない  
  → Mitigation: 入力内容を保持し、インラインでエラーを表示して再試行可能にする。
- [Trade-off] 編集 UI の状態管理が増える  
  → `App` に集約して分散を防ぎ、`useMessages` は一覧データ更新専用の責務に限定する。

## Migration Plan

1. バックエンドに `PUT /api/messages/{id}` を追加してデプロイする（DB 変更なし）。
2. フロントエンドの編集 UI と更新処理をデプロイする。
3. 問題発生時はフロントエンドをロールバックし、編集導線を一時的に無効化する。

## Open Questions

- 空白のみ（例: `"   "`）を空文字と同等に扱うかは今後の UX 方針次第。今回の Step 6 では `""` の拒否を最低要件として実装する。
