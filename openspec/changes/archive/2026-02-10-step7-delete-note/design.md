## Context

Step 6 までで、認証済みユーザーはメッセージの一覧表示・追加・編集が可能になっている。一方で不要なメッセージを削除する導線がなく、タイムラインを整理できない。

現在の実装ではバックエンドのメッセージ API は `GET`/`POST`/`PUT` のみで、フロントエンドのメッセージ操作メニューも「編集」だけを提供している。本 change では Step 7 の要件に合わせ、削除 API と確認付き削除フローを追加する。

## Goals / Non-Goals

**Goals:**
- 認証必須の `DELETE /api/messages/:id` を追加し、成功時に 204、ID 不正時に 400、対象なし時に 404 を返す。
- 削除対象を `id` と `user_id` で絞り込み、他ユーザーのメッセージ削除を防止する。
- メッセージ操作メニューに「削除」を追加し、実行前に確認ダイアログを表示する。
- 確認ダイアログで承認されたときだけ削除を実行し、成功後にタイムラインから対象メッセージを除去する。
- キャンセル時は API を呼ばず、表示を変更しない。

**Non-Goals:**
- ソフトデリート（復元機能）やゴミ箱機能の導入。
- 一括削除、取り消し（Undo）機能の導入。
- クリップボードコピー機能（Step 8 で対応）。
- `messages` テーブルのスキーマ変更。

## Decisions

### 1. 削除 API は既存認証グループ配下に `DELETE /api/messages/{id}` として追加する

- 決定: `main.go` の既存 `/api/messages` ルート群に `DELETE` を追加し、`authMiddleware` を共通利用する。
- 理由: 一覧/追加/編集と同じアクセス制御境界を維持し、認証ロジックを重複させないため。
- 代替案: 削除ハンドラー内で個別認証する方式は重複実装になるため不採用。

### 2. 削除 SQL は `DELETE ... WHERE id = $1 AND user_id = $2` + `RowsAffected` 判定を採用する

- 決定: `Exec` で削除を実行し、`RowsAffected() == 0` を 404 にマップする。
- 理由: 他ユーザーのデータと不存在ケースを同一で安全に扱え、クエリを単純に保てるため。
- 代替案: 事前 `SELECT` で存在確認する方式はクエリ増加と race の余地があるため不採用。

### 3. 削除確認はブラウザ標準ダイアログ（`window.confirm`）を使う

- 決定: メッセージメニューの「削除」押下時に `window.confirm("このメッセージを削除しますか？")` を表示する。
- 理由: Step 7 の必須要件を最小実装で満たし、追加 UI コンポーネントなしで短期間に導入できるため。
- 代替案: カスタムモーダルはデザイン調整・アクセシビリティ実装コストが増えるため現段階では不採用。

### 4. 削除実行と一覧反映は `App.tsx` と `useMessages` の既存責務に寄せる

- 決定: API 呼び出しは `App.tsx` で管理し、`useMessages` にメッセージ除去ヘルパーを追加して表示更新する。
- 理由: 編集機能と同じ責務分割を維持でき、`MessageList` は操作 UI 表示に集中できるため。
- 代替案: `MessageList` 側で直接 fetch を行う方式は状態管理が分散するため不採用。

### 5. 削除失敗時はメッセージを残したままエラーを表示し、再試行可能にする

- 決定: 削除成功までローカル一覧を変更せず、失敗時はユーザーに失敗理由を表示する。
- 理由: 誤って先に非表示にする楽観更新よりも整合性を優先し、デバッグしやすい挙動にするため。
- 代替案: 楽観更新 + 失敗時ロールバックは実装が複雑化するため不採用。

## Risks / Trade-offs

- [Risk] `window.confirm` はブラウザ依存の見た目・体験になる  
  → Mitigation: 本ステップでは要件充足を優先し、将来のカスタムモーダル置換を可能な構造に保つ。
- [Risk] 削除は不可逆で誤操作の影響が大きい  
  → Mitigation: 必ず確認ダイアログを挟み、確認文言を明確化する。
- [Risk] 削除対象が編集中メッセージと衝突する可能性がある  
  → Mitigation: 削除成功時に編集状態をクリアし、UI の不整合を防ぐ。
- [Trade-off] 一括削除や Undo を実装しないため操作性は限定的  
  → Step 7 のスコープを守り、将来機能は別 change で拡張する。

## Migration Plan

1. バックエンドへ `DELETE /api/messages/{id}` を先行デプロイする（DB マイグレーション不要）。
2. フロントエンドの削除導線と確認フローをデプロイする。
3. 問題発生時はフロントエンドをロールバックして削除導線を一時的に無効化する（バックエンド追加 API は後方互換を維持）。

## Open Questions

- 削除失敗時の UI フィードバックをインライン表示・トースト表示のどちらに統一するか。
- 将来的に Undo（短時間復元）要件を追加するか。
