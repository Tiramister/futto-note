## Context

Step 8 では、既存のタイムライン UI に「メッセージ本文のクリップボードコピー」を追加する。  
現在の実装は `MessageList` がメッセージ単位のメニュー UI（編集・削除）を持ち、`App` が非同期処理とエラー状態を集中管理している。  
`docs/future-spec.md` でも「クリップボードコピー」は基本機能に含まれており、モバイル・PC の双方で 1 アクションで本文を再利用できる UX が求められる。  
バックエンド API や DB 変更は不要で、フロントエンドのみで完結する。

## Goals / Non-Goals

**Goals:**
- 既存メッセージメニューから本文コピーを実行できるようにする。
- `navigator.clipboard.writeText(body)` を利用し、成功時に即時フィードバックを表示する。
- 既存の編集・削除フローを壊さず、同一メニュー内で自然に操作できるようにする。
- 主要フロー（コピー成功、失敗時、既存操作の非回帰）をテストで担保する。

**Non-Goals:**
- バックエンド API の追加・変更。
- コピー履歴や複数メッセージ一括コピーなどの拡張機能。
- クリップボード権限要求 UI の独自実装（ブラウザ標準挙動に委ねる）。

## Decisions

### 1. コピー処理は `App` に寄せ、`MessageList` にはコールバックを渡す

- 決定:
  - `App` に `handleCopyMessage(message: Message)` を追加し、`MessageList` へ `onCopy` として渡す。
  - `MessageList` のメニューに「コピー」ボタンを追加し、クリック時に `onCopy(message)` を呼ぶ。
- 理由:
  - 既存でも更新/削除の副作用は `App` にあり、責務分離が明確。
  - 失敗時メッセージや成功フィードバック状態を `App` で一元管理できる。
- 代替案:
  - `MessageList` 内で `navigator.clipboard` を直接呼ぶ案は、UI コンポーネントに副作用と状態が散るため不採用。

### 2. コピー成功フィードバックは「メッセージ単位の短時間アイコン変化」で表現する

- 決定:
  - `copiedMessageId`（または同等 state）を `App` で保持し、一定時間後に解除する。
  - `MessageList` は対象メッセージのメニュー項目またはトリガーに `copied` 状態クラスを反映し、視覚変化を表示する。
- 理由:
  - Step 8 要件である「アイコン変化」を最短経路で満たせる。
  - グローバル toast より対象メッセージが明確で、一覧画面でも認知しやすい。
- 代替案:
  - グローバル通知のみで済ませる案は、どのメッセージをコピーしたかが曖昧になるため不採用。

### 3. エラーハンドリングは既存 `status--error` 表示パターンを再利用する

- 決定:
  - クリップボード書き込み失敗時は `copyError` を更新し、`App` で `role="alert"` のエラー文言を表示する。
  - 別操作（再コピーや編集/削除）開始時に不要なエラーをクリアする。
- 理由:
  - 既存の送信/更新/削除エラーと同一 UX で学習コストが低い。
  - ブラウザ・権限依存で失敗し得る操作のため、黙殺せずユーザーへ通知が必要。
- 代替案:
  - 失敗を無表示にする案は、ユーザーがコピー可否を判断できないため不採用。

### 4. テストは `App.test.tsx` に操作統合、`MessageList.test.tsx` は UI 構造の最小追加に留める

- 決定:
  - `App.test.tsx` で `navigator.clipboard.writeText` をモックし、メニュー操作から呼び出し・フィードバック表示・失敗表示を検証する。
  - 既存の編集/削除テストが回ることを確認し、メニュー追加による回帰を検出する。
  - `MessageList.test.tsx` は必要最小限でコピー項目の存在やメニュー構造維持を確認する。
- 理由:
  - 副作用と状態遷移は `App` 側にあるため、統合テストでの検証が妥当。
  - 過剰な重複テストを避けつつ、回帰しやすい導線を押さえられる。
- 代替案:
  - すべて `MessageList` 単体でテストする案は、`App` 側状態との結合確認が不足するため不採用。

## Risks / Trade-offs

- [Risk] `navigator.clipboard` は secure context や権限制約で失敗する可能性がある  
  → Mitigation: 例外を捕捉してエラー表示し、アプリ全体を不安定にしない。

- [Risk] コピー完了 state の解除タイミング競合（連続コピー時）で表示が不自然になる可能性  
  → Mitigation: 直近コピーを優先し、タイマー管理を 1 か所（`App`）に集約する。

- [Risk] メニュー項目追加でモバイル表示が窮屈になる可能性  
  → Mitigation: 既存クラス設計を踏襲し、`App.css` で最小調整に留める。E2E 前に実機幅で確認する。

## Migration Plan

1. `MessageList` に `onCopy` とコピー項目 UI を追加する。  
2. `App` にコピー処理・成功フィードバック state・失敗 state を追加する。  
3. `App.css` にコピー完了表示用スタイルを追加する。  
4. `App.test.tsx` / `MessageList.test.tsx` を更新し、コピー成功/失敗と既存機能の非回帰を検証する。  
5. 手動でモバイル幅・PC幅双方のメニュー表示を確認する。  

ロールバックは、コピー関連 state/props/UI とテスト差分を一括で戻せば既存編集・削除機能へ復帰できる（API 変更がないためデータ移行不要）。

## Open Questions

- コピー成功時のアイコン変化を「コピー項目内のチェック表示」にするか、「メニュートリガー自体の変化」にするか最終 UI をどちらに寄せるか。
- コピー失敗時のメッセージ文言を汎用（例: 「コピーに失敗しました」）にするか、権限関連を含めた具体文言にするか。
