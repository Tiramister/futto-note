## Context

Step 3〜4 により、認証済みユーザーのメッセージ一覧表示と日付セパレーター表示は実装済みである。一方で新規メッセージの登録手段がないため、`docs/future-spec.md` のコンセプトである「思いついたことを即座に書き留める」体験が成立していない。

本 change では、認証済みユーザー向けの `POST /api/messages` と、タイムライン下部入力エリアの送信機能を実装し、作成成功後の即時反映までを扱う。データモデルは既存 `messages` テーブルを継続利用し、スキーマ変更は行わない。

## Goals / Non-Goals

**Goals:**
- 認証必須の `POST /api/messages` を追加し、空文字入力を 400 で拒否したうえで作成結果を 201 で返却する。
- タイムライン下部の入力エリアで Enter 改行、Ctrl+Enter 送信を実現する。
- 送信成功時に入力欄クリア、タイムライン追記、最下部スクロールを一連で実行する。
- 空入力時はフロントエンドで送信を抑止し、不要な API 呼び出しを防ぐ。

**Non-Goals:**
- メッセージ編集・削除機能（Step 6 以降で対応）。
- メッセージ取得のページネーション／無限スクロール（将来検討）。
- Markdown 対応や本文装飾ルールの変更。
- `messages` テーブル定義の変更。

## Decisions

### 1. `POST /api/messages` は既存認証ミドルウェア配下に追加する

- 決定: `GET /api/messages` と同じ保護境界に `POST /api/messages` を追加し、コンテキストの `user_id` を使って作成ユーザーを確定する。
- 理由: 認証ロジック重複を避け、メッセージ API 群のアクセス制御を一貫化できる。
- 代替案: ハンドラー内で都度セッション検証する方式は、重複実装と保守コスト増のため不採用。

### 2. 作成成功時は DB `RETURNING` の値をそのままレスポンスに使う

- 決定: `INSERT ... RETURNING id, body, created_at` を採用し、フロントエンドはそのレスポンスをタイムラインへ反映する。
- 理由: サーバー確定値（ID・タイムスタンプ）を単一ソースにして、再取得なしで整合した画面更新ができる。
- 代替案: 楽観更新で仮 ID を付与する方式は、今回の要件規模では整合管理コストが高いため不採用。

### 3. 入力検証は「フロントで抑止 + バックエンドで最終防衛」の二段構えにする

- 決定: フロントエンドは空入力時に送信処理を行わず、バックエンドは空文字を 400 で拒否する。
- 理由: UX（無駄な通信削減）と API の堅牢性（不正リクエスト拒否）を両立できる。
- 代替案: どちらか一方のみで検証する方式は、ユーザー体験または安全性のどちらかが弱くなるため不採用。

### 4. Enter/Ctrl+Enter 制御は `textarea` のキーボードイベントで行う

- 決定: `textarea` を採用し、Enter では標準改行動作を維持し、Ctrl+Enter で `preventDefault` の上で送信する。
- 理由: 1 行入力と複数行入力の両立を最小構成で実現できる。
- 代替案: `input` 要素では改行要件を満たせないため不採用。

### 5. 送信後スクロールは「成功時のみ最下部追従」に限定する

- 決定: `POST /api/messages` 成功時にのみ最下部へスクロールし、失敗時は入力内容を保持する。
- 理由: 失敗時の再送しやすさを維持しつつ、新規投稿時の視認性を確保できる。
- 代替案: 送信開始時にスクロールする方式は、失敗時に表示と実データが乖離するため不採用。

## Risks / Trade-offs

- [Risk] Ctrl+Enter 連打で重複投稿が発生する可能性  
  → Mitigation: 送信中はボタンと Ctrl+Enter 送信を一時無効化する。
- [Risk] 通信失敗時に投稿できない状態が続く可能性  
  → Mitigation: 入力内容を維持し、エラーメッセージと再送可能な UI を提供する。
- [Trade-off] 楽観更新を採用しないため、反映はレスポンス待ちになる  
  → 利点: ID/時刻の整合性が高い。欠点: 低速回線で反映体感が遅れる。

## Migration Plan

1. バックエンドに `POST /api/messages` を追加してデプロイする（DB マイグレーション不要）。
2. フロントエンドの入力送信機能をデプロイし、統合して動作確認する。
3. ロールバック時はフロントエンドのみ先に戻すことで投稿操作を無効化できる（既存一覧表示は維持可能）。

## Open Questions

- 空白のみ入力（例: `"   "`）を空入力として扱うかは未確定。Step 5 の最小要件は「空文字拒否」だが、実装時に UX 観点で扱いを確定する。
